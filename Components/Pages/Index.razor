@page "/"
@using Portfolio.Services
@inject TerminalCommandService CommandService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>Hyunjo Jung - Developer Portfolio</PageTitle>

<HeadContent>
    <meta name="description" content="Hyunjo Jung's developer portfolio and blog" />
    <meta name="keywords" content="developer, portfolio, blog, hyunjo jung" />
</HeadContent>

<div class="terminal-container">
    <div class="terminal-header">
        <span class="terminal-title">hyunjo@@dev:~$ cat README.md</span>
        <div class="terminal-controls">
            <span class="control-btn close"></span>
            <span class="control-btn minimize"></span>
            <span class="control-btn maximize"></span>
        </div>
    </div>

    <div class="terminal-body">
        <div class="command-line">
            <span class="prompt">hyunjo@@dev</span>
            <span class="path">~</span>
            <span class="cursor">$</span>
            <span class="command">cat README.md</span>
        </div>

        <div class="welcome-section">
            <pre class="ascii-art">
██╗  ██╗██╗   ██╗██╗   ██╗███╗   ██╗     ██╗ ██████╗
██║  ██║╚██╗ ██╔╝██║   ██║████╗  ██║     ██║██╔═══██╗
███████║ ╚████╔╝ ██║   ██║██╔██╗ ██║     ██║██║   ██║
██╔══██║  ╚██╔╝  ██║   ██║██║╚██╗██║██   ██║██║   ██║
██║  ██║   ██║   ╚██████╔╝██║ ╚████║╚█████╔╝╚██████╔╝
╚═╝  ╚═╝   ╚═╝    ╚═════╝ ╚═╝  ╚═══╝ ╚════╝  ╚═════╝
            </pre>

            <div class="intro">
                <h1><span class="hash">#</span> Welcome to my terminal</h1>
                <p class="description">Developer, Blogger, Open Source Enthusiast</p>
            </div>

            <div class="directory-listing">
                <div class="command-line">
                    <span class="prompt">hyunjo@@dev</span>
                    <span class="path">~</span>
                    <span class="cursor">$</span>
                    <span class="command">ls -la</span>
                </div>

                <div class="file-list">
                    <div class="file-item directory" @onclick='() => Navigation.NavigateTo("/blog")'>
                        <span class="permissions">drwxr-xr-x</span>
                        <span class="size">4.0K</span>
                        <span class="date">Dec 02 18:00</span>
                        <span class="name directory-name">blog/</span>
                        <span class="description">Technical articles and tutorials</span>
                    </div>
                    <div class="file-item directory" @onclick='() => Navigation.NavigateTo("/about")'>
                        <span class="permissions">drwxr-xr-x</span>
                        <span class="size">4.0K</span>
                        <span class="date">Dec 02 18:00</span>
                        <span class="name directory-name">about/</span>
                        <span class="description">About me and my experience</span>
                    </div>
                    <div class="file-item file">
                        <span class="permissions">-rw-r--r--</span>
                        <span class="size">1.2K</span>
                        <span class="date">Dec 02 18:00</span>
                        <span class="name file-name">README.md</span>
                        <span class="description">You are here</span>
                    </div>
                </div>
            </div>

            <div class="quick-commands">
                <div class="command-hint">
                    <span class="hint-label">Quick commands:</span>
                    <div class="hints">
                        <code>cd blog</code> <span class="hint-desc">Browse articles</span>
                        <code>cd about</code> <span class="hint-desc">Learn about me</span>
                        <code>help</code> <span class="hint-desc">Show all commands</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="terminal-input-section">
            <div class="command-line">
                <span class="prompt">hyunjo@@dev</span>
                <span class="path">~</span>
                <span class="cursor">$</span>
                <input type="text"
                       class="terminal-input"
                       @bind="terminalInput"
                       @bind:event="oninput"
                       @onkeydown="HandleTerminalKeyDown"
                       @ref="terminalInputElement"
                       placeholder="Type 'help' or 'cd blog'..."
                       autocomplete="off"
                       spellcheck="false" />
            </div>
        </div>

        @if (!string.IsNullOrEmpty(commandOutput))
        {
            <div class="command-output">
                <pre>@commandOutput</pre>
            </div>
        }
    </div>
</div>

@code {
    private string terminalInput = string.Empty;
    private ElementReference terminalInputElement;
    private string commandOutput = string.Empty;

    private async Task HandleTerminalKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(terminalInput))
        {
            var command = terminalInput.Trim();
            terminalInput = string.Empty;

            var result = await CommandService.ExecuteCommandAsync(command, "/");

            if (!string.IsNullOrEmpty(result.NavigateTo))
            {
                // Force load for auth endpoints (/login, /logout) to hit the middleware
                bool forceLoad = result.NavigateTo.Equals("/login", StringComparison.OrdinalIgnoreCase) || 
                                 result.NavigateTo.Equals("/logout", StringComparison.OrdinalIgnoreCase);
                                 
                Navigation.NavigateTo(result.NavigateTo, forceLoad);
            }
            else if (!string.IsNullOrEmpty(result.Output))
            {
                commandOutput = result.Output;
            }
        }
    }
}
